name: Daily Task Organizer Access

on:
  schedule:
    # æ¯æœ9æ™‚ JST (UTC 0:00)
    - cron: '0 0 * * *'
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

jobs:
  access-notion:
    runs-on: ubuntu-latest
    
    steps:
      - name: Random Skip Check
        id: skip_check
        run: |
          # 1/3ã®ç¢ºç‡ã§ã‚¹ã‚­ãƒƒãƒ— (0-2ã®ä¹±æ•°ã‚’ç”Ÿæˆã—ã€0ã®å ´åˆã‚¹ã‚­ãƒƒãƒ—)
          random_num=$((RANDOM % 3))
          echo "Random number: $random_num"
          
          if [ "$random_num" -eq 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "ğŸ² Skipping access today (1/3 probability)"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ğŸ² Will access today"
          fi
      
      - name: Access Google Apps Script Endpoint
        if: steps.skip_check.outputs.skip != 'true'
        run: |
          # Google Apps Scriptã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è‡ªå‹•çš„ã«ãƒ•ã‚©ãƒ­ãƒ¼ï¼‰
          echo "Accessing Task Organizer..."
          
          # curlã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è‡ªå‹•çš„ã«ãƒ•ã‚©ãƒ­ãƒ¼ (-L ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
          response=$(curl -L -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: GitHub-Actions-Bot" \
            "https://script.google.com/a/macros/trns.ltd/s/AKfycbyt8d8-FoYuOaUiT7MBxGL4W5Vyl6Xithx-DcyJT2Imp5Xjo2D8fDaUOJJNEtNRuOQ/exec?userName=%E8%93%AE%E8%A6%8B%E5%84%AA%E5%A4%AA")
          
          echo "Final HTTP Response Code: $response"
          
          # ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã®URLã‚‚è¡¨ç¤º
          redirect_url=$(curl -s -w "%{redirect_url}" -o /dev/null \
            "https://script.google.com/a/macros/trns.ltd/s/AKfycbyt8d8-FoYuOaUiT7MBxGL4W5Vyl6Xithx-DcyJT2Imp5Xjo2D8fDaUOJJNEtNRuOQ/exec?userName=%E8%93%AE%E8%A6%8B%E5%84%AA%E5%A4%AA")
          
          if [ -n "$redirect_url" ]; then
            echo "Redirected to: $redirect_url"
          fi
          
          # æˆåŠŸã®ç¢ºèª (æœ€çµ‚çš„ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ200 OK)
          if [ "$response" = "200" ]; then
            echo "âœ… Successfully accessed Task Organizer"
          else
            echo "âŒ Failed to access Task Organizer (Final HTTP $response)"
            exit 1
          fi
      
      - name: Log Access Time
        run: |
          echo "Accessed at: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"